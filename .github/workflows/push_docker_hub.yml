name: Build, Push and Notify

on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: jyyqaj/certbot-aliyun-docker
          tags: |
            type=raw,value=latest
            type=sha
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        id: build-push
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Send build notification
        if: always() && github.ref == 'refs/heads/main'
        uses: distributhor/workflow-webhook@v2
        env:
          webhook_url: ${{ secrets.FEISHU_WEBHOOK_URL }}
          webhook_method: POST
          webhook_content_type: 'application/json'
          webhook_body: |
            {
              "msg_type": "post",
              "content": {
                "post": {
                  "zh_cn": {
                    "title": "${{ job.status == 'success' && 'âœ… Docker æ„å»ºæˆåŠŸ' || 'âŒ Docker æ„å»ºå¤±è´¥' }}",
                    "content": [
                      [
                        {
                          "tag": "text",
                          "text": "ğŸ“¦ é¡¹ç›®: ${{ github.repository }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "ğŸ‘¤ è§¦å‘è€…: ${{ github.actor }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "ğŸ†” æäº¤: ${{ github.sha }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "ğŸ·ï¸ æ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "â±ï¸ æŒç»­æ—¶é—´: ${{ job.steps[4].conclusion && 'æˆåŠŸ' || 'å¤±è´¥' }} (${{ job.steps[4].outcome }})"
                        }
                      ],
                      [
                        {
                          "tag": "a",
                          "text": "ğŸ” æŸ¥çœ‹æ„å»ºè¯¦æƒ…",
                          "href": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    ]
                  }
                }
              }
            }
            
