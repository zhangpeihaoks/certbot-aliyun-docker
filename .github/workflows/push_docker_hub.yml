name: Build, Push and Notify

on:
  push:
    branches: [ main ]
    tags: [ v* ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        id: build-push
        with:
          context: .
          push: true
          tags: |
            jyyqaj/certbot-aliyun-docker:latest
            jyyqaj/certbot-aliyun-docker:${{ github.sha }}

      - name: Generate webhook signature
        id: sign
        run: |
          TIMESTAMP=$(date +%s)
          SECRET=${{ secrets.FEISHU_WEBHOOK_SECRET }}
          SIGN_STRING="$TIMESTAMP\n$SECRET"
          SIGNATURE=$(echo -en "$SIGN_STRING" | openssl dgst -sha256 -hmac "$SECRET" -binary | base64)
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "SIGNATURE=$SIGNATURE" >> $GITHUB_ENV

      - name: Send build notification
        if: always() && github.ref == 'refs/heads/main'
        uses: distributhor/workflow-webhook@v2
        env:
          webhook_url: ${{ secrets.FEISHU_WEBHOOK_URL }}
          webhook_method: POST
          webhook_content_type: 'application/json'
          webhook_headers: |
            X-Lark-Request-Timestamp: ${{ env.TIMESTAMP }}
            X-Lark-Signature: ${{ env.SIGNATURE }}
          webhook_body: |
            {
              "msg_type": "post",
              "content": {
                "post": {
                  "zh_cn": {
                    "title": "${{ job.status == 'success' && 'âœ… Docker æ„å»ºæˆåŠŸ' || 'âŒ Docker æ„å»ºå¤±è´¥' }}",
                    "content": [
                      [
                        {
                          "tag": "text",
                          "text": "ğŸ“¦ é¡¹ç›®: ${{ github.repository }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "ğŸ‘¤ è§¦å‘è€…: ${{ github.actor }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "ğŸ†” æäº¤: ${{ github.sha }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "ğŸ·ï¸ é•œåƒæ ‡ç­¾: jyyqaj/certbot-aliyun-docker:${{ github.sha }}"
                        }
                      ],
                      [
                        {
                          "tag": "text",
                          "text": "â±ï¸ çŠ¶æ€: ${{ job.status }} (${{ steps.build-push.outcome }})"
                        }
                      ],
                      [
                        {
                          "tag": "a",
                          "text": "ğŸ” æŸ¥çœ‹æ„å»ºè¯¦æƒ…",
                          "href": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    ]
                  }
                }
              }
            }